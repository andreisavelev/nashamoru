$(document).ready(function(){var o=L.map("js-map").setView([43.121,131.923],13),e=new Firebase("https://toshamora.firebaseio.com/nashamoru/");L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',maxZoom:18,id:"savelevcorr.cieznawwh00pgtbm1kqpsucl5",accessToken:"pk.eyJ1Ijoic2F2ZWxldmNvcnIiLCJhIjoiY2llem5heHA2MDBxNHQ0bTRsMW55eXdjbiJ9.lgwTaEKIr1Fxc-L57JRFOQ"}).addTo(o);var n=new L.FeatureGroup,a="psg",t=($(".js-driver-link"),$(".js-passenger-link")),r=function(o){var e=document.cookie.match(new RegExp("(?:^|; )"+o.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return e?decodeURIComponent(e[1]):void 0},c=function(o,e,n){n=n||{};var a=n.expires;if("number"==typeof a&&a){var i=new Date;i.setTime(i.getTime()+1e3*a),a=n.expires=i}a&&a.toUTCString&&(n.expires=a.toUTCString()),e=encodeURIComponent(e);var t=o+"="+e;for(var r in n){t+="; "+r;var c=n[r];c!==!0&&(t+="="+c)}document.cookie=t},l=function(){return Math.floor(1e4*Math.random())},s=function(e){return L.marker([e.lat,e.lng],{icon:g,draggable:!0}).addTo(o)},d=function(o,n,a){var i,t;e.once("value",function(a){return a.forEach(function(a){i=a.key(),t=a.val(),t.id===o&&(console.log(i),e.child(i).set({id:t.id,position:n},function(o){o?console.log(o):console.log("Updated")}))})})},p=function(o,n){return e.push(o,n())},u=function(o,n){var a;e.once("value",function(e){return e.forEach(function(e){a=e.val(),a.id===o&&n(a.position)})})},g=(r(a),L.divIcon({className:"my-div-icon",iconSize:L.point(32,32)})),v=[];if(r(a)){var f=JSON.parse(r(a));console.log(f.id);var m=u(f.id,function(e){console.log("getuserData called"),m=L.marker([e.lat.toFixed(3),e.lng.toFixed(3)],{icon:g,draggable:!0}).addTo(o),m.on("dragend",function(o){var e=o.target._latlng;d(f.id,e)})});console.log("WE HAVE COOKIE")}else e.once("value",function(e){console.log("DROW INVALID POEOPLE"),e.forEach(function(e){var n=(e.key(),e.val());v.push(L.marker([n.position.lat,n.position.lng],{icon:g,draggable:!0}).bindPopup("<div> Привет </div>",{className:n.id}).addTo(o))})}),e.on("child_changed",function(e,n){for(var a=(e.key(),e.val()),i=0;i<v.length;i++)v[i]._popup.options.className===a.id&&(o.removeLayer(v[i]),console.log("Yes",v[i]),v[i]=L.marker([a.position.lat,a.position.lng],{icon:g,draggable:!0}).bindPopup("<div> Пока! </div>",{className:a.id}).addTo(o))});var h;$(t).on("click",function(e){var t=L.layerGroup(v);for(console.log(t),i=0;i<v.length;i++)o.removeLayer(v[i]);e.preventDefault(),o.removeLayer(n),c(a,JSON.stringify({id:l()})),"undefined"==typeof h?(o.once("click",function(o){var e=o.latlng,n=JSON.parse(r(a)),i={id:n.id,position:e},t=s(e);p(i,function(){console.log("SEAVED")}),t.on("dragend",function(o){var e=o.target._latlng;d(n.id,e)})}),h=1,console.log("IN THE IF STATEMENT",h)):o.off("click"),e.preventDefault()})});