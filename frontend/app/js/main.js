$(document).ready(function(){var o=L.map("js-map").setView([43.121,131.923],13),e=new Firebase("https://toshamora.firebaseio.com/nashamoru/");L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',maxZoom:18,id:"savelevcorr.cieznawwh00pgtbm1kqpsucl5",accessToken:"pk.eyJ1Ijoic2F2ZWxldmNvcnIiLCJhIjoiY2llem5heHA2MDBxNHQ0bTRsMW55eXdjbiJ9.lgwTaEKIr1Fxc-L57JRFOQ"}).addTo(o);var n=new L.FeatureGroup,a="psg",t=($(".js-driver-link"),$(".js-passenger-link")),r=function(o){var e=document.cookie.match(new RegExp("(?:^|; )"+o.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return e?decodeURIComponent(e[1]):void 0},c=function(o,e,n){n=n||{};var i=n.expires;if("number"==typeof i&&i){var a=new Date;a.setTime(a.getTime()+1e3*i),i=n.expires=a}i&&i.toUTCString&&(n.expires=i.toUTCString()),e=encodeURIComponent(e);var t=o+"="+e;for(var r in n){t+="; "+r;var c=n[r];c!==!0&&(t+="="+c)}document.cookie=t},l=function(){return Math.floor(1e4*Math.random())},s=function(e){L.marker([e.lat,e.lng],{icon:v}).addTo(o)},d=function(o,n,i){var a,t;e.once("value",function(i){return i.forEach(function(i){a=i.key(),t=i.val(),t.id===o&&(console.log(a),e.child(a).set({id:t.id,position:n},function(o){o?console.log(o):console.log("Updated")}))})})},p=function(o,n){return e.push(o,n())},u=function(o,n){var i;e.once("value",function(e){return e.forEach(function(e){i=e.val(),i.id===o&&n(i.position)})})},v=(r(a),L.divIcon({className:"my-div-icon",iconSize:L.point(32,32)})),f=[];if(r(a)){var m=JSON.parse(r(a));console.log(m.id);var g=u(m.id,function(e){v.id=m.id,console.log("getuserData called"),g=L.marker([e.lat.toFixed(3),e.lng.toFixed(3)],{icon:v,draggable:!0}).addTo(o),g.on("dragend",function(o){var e=o.target._latlng;d(m.id,e)})});console.log("WE HAVE COOKIE")}else e.once("value",function(e){console.log("DROW INVALID POEOPLE"),e.forEach(function(e){var n=(e.key(),e.val());f.push(L.marker([n.position.lat,n.position.lng],{icon:v}).bindPopup("<div> Привет </div>",{className:n.id}).addTo(o))})}),e.on("child_changed",function(e,n){for(var i=(e.key(),e.val()),a=0;a<f.length;a++)f[a]._popup.options.className===i.id&&(o.removeLayer(f[a]),console.log("Yes",f[a]),f[a]=L.marker([i.position.lat,i.position.lng],{icon:v}).bindPopup("<div> Пока! </div>",{className:i.id}).addTo(o))});var h;$(t).on("click",function(e){var t=L.layerGroup(f);for(console.log(t),i=0;i<f.length;i++)o.removeLayer(f[i]);e.preventDefault(),o.removeLayer(n),c(a,JSON.stringify({id:l()})),"undefined"==typeof h?(o.once("click",function(o){var e=o.latlng,n=JSON.parse(r(a)),i={id:n.id,position:e};s(e),p(i,function(){console.log("SEAVED")})}),h=1,console.log("IN THE IF STATEMENT",h)):o.off("click"),e.preventDefault()})});