$(document).ready(function(){var o=L.map("js-map").setView([43.121,131.923],13),n=new Firebase("https://toshamora.firebaseio.com/nashamoru/");L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',maxZoom:18,id:"savelevcorr.cieznawwh00pgtbm1kqpsucl5",accessToken:"pk.eyJ1Ijoic2F2ZWxldmNvcnIiLCJhIjoiY2llem5heHA2MDBxNHQ0bTRsMW55eXdjbiJ9.lgwTaEKIr1Fxc-L57JRFOQ"}).addTo(o);var e=new L.FeatureGroup,a="psg",t="drvr",r=$(".js-driver-link"),c=$(".js-passenger-link"),d=function(o){var n=document.cookie.match(new RegExp("(?:^|; )"+o.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return n?decodeURIComponent(n[1]):void 0},l=function(o,n,e){e=e||{};var i=e.expires;if("number"==typeof i&&i){var a=new Date;a.setTime(a.getTime()+1e3*i),i=e.expires=a}i&&i.toUTCString&&(e.expires=i.toUTCString()),n=encodeURIComponent(n);var t=o+"="+n;for(var r in e){t+="; "+r;var c=e[r];c!==!0&&(t+="="+c)}document.cookie=t},s=function(o){l(o,"",{expires:-1})},p=function(){return Math.floor(1e4*Math.random())},u=function(n){return L.marker([n.lat,n.lng],{icon:m,draggable:!0}).addTo(o)},v=function(o,e,i){var a,t;n.once("value",function(i){return i.forEach(function(i){a=i.key(),t=i.val(),t.id===o&&(console.log(a),n.child(a).set({id:t.id,position:e},function(o){o?console.log(o):console.log("Updated")}))})})},g=function(o,e){return n.push(o,e())},f=function(o,e){var i;n.once("value",function(n){return n.forEach(function(n){i=n.val(),i.id===o&&e(i.position)})})},m=(d(a),L.divIcon({className:"my-div-icon",iconSize:L.point(32,32)})),h=[];if(d(a)){var k=JSON.parse(d(a));console.log(k.id);var y=f(k.id,function(n){console.log("getuserData called"),y=L.marker([n.lat.toFixed(3),n.lng.toFixed(3)],{icon:m,draggable:!0}).addTo(o),y.on("dragend",function(o){var n=o.target._latlng;v(k.id,n)})});console.log("WE HAVE COOKIE")}else n.once("value",function(n){console.log("DROW INVALID POEOPLE"),n.forEach(function(n){var e=(n.key(),n.val());h.push(L.marker([e.position.lat,e.position.lng],{icon:m}).bindPopup("<div> Привет </div>",{className:e.id}).addTo(o))})}),n.on("child_changed",function(n,e){for(var i=(n.key(),n.val()),a=0;a<h.length;a++)h[a]._popup.options.className===i.id&&(o.removeLayer(h[a]),console.log("Yes",h[a]),h[a]=L.marker([i.position.lat,i.position.lng],{icon:m,draggable:!0}).bindPopup("<div> Пока! </div>",{className:i.id}).addTo(o))}),n.on("child_added",function(n,e){var i=(n.key(),n.val());h.push(L.marker([i.position.lat,i.position.lng],{icon:m,draggable:!0}).bindPopup("<div> Я новенький </div>",{className:i.id}).addTo(o))});var b;$(c).on("click",function(n){var r=L.layerGroup(h);for(console.log(r),i=0;i<h.length;i++)o.removeLayer(h[i]);s(t),o.removeLayer(e),l(a,JSON.stringify({id:p()})),"undefined"==typeof b?(o.once("click",function(o){var n=o.latlng,e=JSON.parse(d(a)),i={id:e.id,position:n},t=u(n);g(i,function(){console.log("SEAVED")}),t.on("dragend",function(o){var n=o.target._latlng;v(e.id,n)})}),b=1,console.log("IN THE IF STATEMENT",b)):o.off("click"),n.preventDefault()}),$(r).on("click",function(e){if(d(a))s(a),l(t,!0),n.once("value",function(n){console.log("DROW INVALID POEOPLE"),n.forEach(function(n){var e=(n.key(),n.val());h.push(L.marker([e.position.lat,e.position.lng],{icon:m}).bindPopup("<div> Привет </div>",{className:e.id}).addTo(o))})}),n.on("child_changed",function(n,e){for(var i=(n.key(),n.val()),a=0;a<h.length;a++)h[a]._popup.options.className===i.id&&(o.removeLayer(h[a]),console.log("Yes",h[a]),h[a]=L.marker([i.position.lat,i.position.lng],{icon:m}).bindPopup("<div> Пока! </div>",{className:i.id}).addTo(o))}),n.on("child_added",function(n,e){var i=(n.key(),n.val());h.push(L.marker([i.position.lat,i.position.lng],{icon:m}).bindPopup("<div> Я новенький </div>",{className:i.id}).addTo(o))});else{if(d(t))return;l(t,!0),n.once("value",function(n){console.log("DROW INVALID POEOPLE"),n.forEach(function(n){var e=(n.key(),n.val());h.push(L.marker([e.position.lat,e.position.lng],{icon:m}).bindPopup("<div> Привет </div>",{className:e.id}).addTo(o))})}),n.on("child_changed",function(n,e){for(var i=(n.key(),n.val()),a=0;a<h.length;a++)h[a]._popup.options.className===i.id&&(o.removeLayer(h[a]),console.log("Yes",h[a]),h[a]=L.marker([i.position.lat,i.position.lng],{icon:m}).bindPopup("<div> Пока! </div>",{className:i.id}).addTo(o))}),n.on("child_added",function(n,e){var i=(n.key(),n.val());h.push(L.marker([i.position.lat,i.position.lng],{icon:m,draggable:!0}).bindPopup("<div> Я новенький </div>",{className:i.id}).addTo(o))})}e.preventDefault()})});